<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sedayu Hub - Kuliner, Balon & Bucket</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .pattern-icon { position: absolute; opacity: 0.05; pointer-events: none; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-custom { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-[#FDFBF7] text-gray-800 relative overflow-x-hidden min-h-screen pb-24 md:pb-0">

    <!-- BACKGROUND PATTERN (SVG Inline) -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <!-- Leaf -->
        <svg class="pattern-icon text-green-700 w-64 h-64 top-[-20px] left-[-20px] rotate-45" fill="currentColor" viewBox="0 0 24 24"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path></svg>
        <!-- Flame -->
        <svg class="pattern-icon text-red-600 w-80 h-80 bottom-[10%] right-[-30px] -rotate-12" fill="currentColor" viewBox="0 0 24 24"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-5-6.33-5-6.33S1 10.62 1 12a2.5 2.5 0 0 0 2.5 2.5 2.5 2.5 0 0 0 2.5-2.5 2.5 2.5 0 0 0 2.5 2.5z"/></svg>
        <!-- Wheat -->
        <svg class="pattern-icon text-amber-600 w-40 h-40 top-[15%] right-[5%] rotate-[130deg]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M2 22l10-10"></path><path d="M16 8l-2-2"></path><path d="M9 15l2-2"></path></svg>
    </div>

    <!-- NAVBAR -->
    <nav class="glass shadow-sm sticky top-0 z-40 border-b border-orange-100">
        <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="h-12 w-12 rounded-lg overflow-hidden flex items-center justify-center bg-white shadow-sm border border-orange-50">
                    <img src="https://i.ibb.co.com/xSw0nphy/Whats-App-Image-2025-12-10-at-11-07-06-removebg-preview.png" alt="Logo" class="w-full h-full object-contain p-1">
                </div>
                <div>
                    <h1 class="text-xl font-extrabold text-gray-800 leading-tight">Sedayu Hub</h1>
                    <p class="text-xs text-orange-600 font-semibold">Sawojajar 1, Malang</p>
                </div>
            </div>
            <button onclick="toggleCart()" class="relative p-2 text-gray-600 hover:bg-orange-50 rounded-full transition-colors">
                <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                <span id="cart-badge" class="hidden absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full shadow-sm animate-pulse">0</span>
            </button>
        </div>
    </nav>

    <!-- HERO SECTION -->
    <div class="max-w-4xl mx-auto pt-6 px-4 pb-2 relative z-10">
        <div class="bg-gradient-to-r from-orange-600 to-red-700 text-white py-10 px-6 text-center rounded-2xl shadow-xl shadow-orange-200 relative overflow-hidden">
            <div class="absolute opacity-10 top-0 left-0 w-full h-full pointer-events-none">
                 <i data-lucide="chef-hat" class="absolute top-2 left-2 w-20 h-20 text-white opacity-20 rotate-12"></i>
                 <i data-lucide="party-popper" class="absolute bottom-2 right-2 w-24 h-24 text-yellow-300 opacity-20 -rotate-12"></i>
            </div>
            <div class="relative z-10">
                <h2 class="text-3xl md:text-4xl font-black mb-3 drop-shadow-md">Citarasa & Cerita</h2>
                <p class="text-orange-50 text-sm md:text-base max-w-lg mx-auto mb-6 font-medium">Dari dapur penuh rempah hingga dekorasi penuh warna. <span class="block mt-1 font-bold text-yellow-200">Spesial untuk momen Anda.</span></p>
                <div class="flex justify-center gap-3">
                    <a href="https://instagram.com/dapur.sedayu" target="_blank" class="flex items-center space-x-2 bg-white text-orange-600 px-4 py-2 rounded-full text-xs font-bold hover:bg-orange-50 transition shadow-sm border-b-2 border-orange-200">
                        <i data-lucide="instagram" class="w-3 h-3"></i> <span>@dapur.sedayu</span>
                    </a>
                    <a href="https://instagram.com/bloomsbaloon" target="_blank" class="flex items-center space-x-2 bg-white/20 text-white px-4 py-2 rounded-full text-xs font-bold hover:bg-white/30 transition backdrop-blur-sm border border-white/30">
                        <i data-lucide="instagram" class="w-3 h-3"></i> <span>@bloomsbaloon</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- TABS -->
    <div class="max-w-4xl mx-auto px-4 my-6 sticky top-[72px] z-30 bg-[#FDFBF7]/95 backdrop-blur py-2">
        <div class="flex space-x-2 overflow-x-auto pb-1 scrollbar-hide" id="tabs-container">
            <!-- Tabs injected by JS -->
        </div>
    </div>

    <!-- PRODUCT GRID -->
    <div class="max-w-4xl mx-auto px-4 mb-24 relative z-10">
        <div id="loading-indicator" class="flex flex-col items-center justify-center py-20">
            <i data-lucide="loader-2" class="w-10 h-10 text-orange-500 animate-spin-custom mb-2"></i>
            <p class="text-gray-500 text-sm font-medium">Sedang mengambil menu terbaru...</p>
        </div>
        <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-5 hidden">
            <!-- Products injected by JS -->
        </div>
    </div>

    <!-- AI FLOATING BUTTON -->
    <div class="fixed bottom-24 left-4 z-30">
        <button onclick="toggleAI()" class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-3 rounded-full shadow-xl shadow-purple-500/30 flex items-center gap-2 hover:scale-105 transition-transform">
            <i data-lucide="sparkles" class="w-6 h-6 animate-pulse"></i>
            <span class="font-bold text-sm hidden md:block">Asisten Ajaib</span>
        </button>
    </div>

    <!-- MOBILE CART BUTTON -->
    <div id="mobile-cart-btn" class="fixed bottom-6 left-4 right-4 md:hidden z-30 hidden">
        <button onclick="toggleCart()" class="w-full bg-gray-900 text-white shadow-2xl shadow-gray-900/40 py-4 px-6 rounded-2xl flex items-center justify-between border-t border-gray-700 backdrop-blur-xl">
            <div class="flex items-center space-x-3">
                <div class="bg-red-500 px-2.5 py-1 rounded-lg text-xs font-bold text-white" id="mobile-cart-count">0 Item</div>
                <span class="font-semibold text-sm text-gray-200">Total Pesanan</span>
            </div>
            <span class="font-bold text-lg text-white" id="mobile-cart-total">Rp 0</span>
        </button>
    </div>

    <!-- CART MODAL -->
    <div id="cart-modal" class="fixed inset-0 z-50 flex justify-end hidden">
        <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="toggleCart()"></div>
        <div class="relative w-full max-w-md bg-[#FDFBF7] h-full shadow-2xl flex flex-col transform transition-transform duration-300 translate-x-full" id="cart-panel">
            <div class="p-5 border-b border-gray-200 flex items-center justify-between bg-white">
                <h2 class="text-lg font-bold flex items-center gap-2 text-gray-800">
                    <i data-lucide="shopping-cart" class="w-5 h-5 text-orange-600"></i> Checkout
                </h2>
                <button onclick="toggleCart()" class="p-2 hover:bg-gray-100 rounded-full text-gray-400 hover:text-red-500 transition"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto p-5 space-y-4" id="cart-items">
                <!-- Cart items injected here -->
            </div>

            <!-- Checkout Form -->
            <div id="cart-footer" class="hidden p-5 border-t border-gray-200 bg-white space-y-4 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
                
                <!-- Opsi Pengiriman -->
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block">Opsi Pengiriman</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="setDelivery('pickup')" id="btn-pickup" class="py-3 px-2 rounded-xl border text-sm font-bold flex flex-col items-center justify-center gap-1 transition-all bg-orange-50 border-orange-500 text-orange-700">
                            <i data-lucide="store" class="w-4 h-4"></i> Ambil di Dapur
                        </button>
                        <button onclick="setDelivery('delivery')" id="btn-delivery" class="py-3 px-2 rounded-xl border text-sm font-bold flex flex-col items-center justify-center gap-1 transition-all bg-white border-gray-200 text-gray-500">
                            <i data-lucide="bike" class="w-4 h-4"></i> Antar Kurir
                        </button>
                    </div>
                    <p id="delivery-note" class="hidden text-[10px] text-center text-orange-600 bg-orange-50 py-1 rounded font-medium">*Ongkir dibayar tunai ke kurir (COD)</p>
                </div>

                <div class="space-y-3">
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-1">Nama Pemesan</label>
                        <input type="text" id="cust-name" placeholder="Nama Anda..." class="w-full bg-transparent text-sm font-bold text-gray-800 outline-none placeholder:font-normal">
                    </div>
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-1">Catatan</label>
                        <textarea id="cust-note" placeholder="Contoh: Pedas, pita biru..." class="w-full bg-transparent text-sm font-medium text-gray-800 outline-none h-10 resize-none placeholder:font-normal"></textarea>
                    </div>
                </div>

                <!-- Info Pembayaran -->
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-3">
                    <div class="flex items-center gap-2 mb-1">
                        <i data-lucide="credit-card" class="w-4 h-4 text-blue-600"></i>
                        <span class="text-[10px] font-bold text-blue-600 uppercase tracking-wider">Transfer Pembayaran</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3 bg-white p-2 rounded-lg border border-blue-100">
                            <div class="h-6 w-10 bg-blue-600 rounded flex items-center justify-center text-[10px] font-bold text-white">BNI</div>
                            <div><p class="text-xs font-bold text-gray-800">699441202</p><p class="text-[10px] text-gray-500">Finda Fatmawati</p></div>
                        </div>
                        <div class="flex items-center gap-3 bg-white p-2 rounded-lg border border-blue-100">
                            <div class="h-6 w-10 bg-blue-800 rounded flex items-center justify-center text-[10px] font-bold text-white">BCA</div>
                            <div><p class="text-xs font-bold text-gray-800">6225038906</p><p class="text-[10px] text-gray-500">Finda Fatmawati</p></div>
                        </div>
                    </div>
                </div>

                <div class="pt-2">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-gray-500 text-sm font-medium">Total Tagihan</span>
                        <span class="text-xl font-black text-gray-900" id="cart-total-display">Rp 0</span>
                    </div>
                    <button onclick="processCheckout()" id="btn-checkout" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-green-200 active:scale-[0.98] transition-all">
                        <i data-lucide="file-text" class="w-5 h-5"></i> Kirim Struk & Order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI MODAL -->
    <div id="ai-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleAI()"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-fade-in">
            <button onclick="toggleAI()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center p-3 bg-purple-100 rounded-full mb-3 text-purple-600">
                    <i data-lucide="sparkles" class="w-7 h-7"></i>
                </div>
                <h3 class="text-xl font-black text-gray-800">Sedayu AI Assistant ‚ú®</h3>
                <p class="text-sm text-gray-500 mt-1">Bingung mau kasih kado apa? Atau butuh ucapan keren? Ceritain aja!</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-600 uppercase mb-1 block">Ceritakan situasimu</label>
                    <textarea id="ai-prompt" class="w-full border border-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-purple-500 outline-none resize-none h-24 bg-gray-50" placeholder="Contoh: Ulang tahun pacar suka warna biru, atau acara perpisahan teman kantor..."></textarea>
                </div>

                <button onclick="callGemini()" id="btn-ask-ai" class="w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2 text-white bg-purple-600 hover:bg-purple-700 shadow-lg shadow-purple-200 transition-all">
                    <i data-lucide="send" class="w-4 h-4"></i> Tanya AI Sekarang
                </button>

                <div id="ai-result-container" class="hidden bg-purple-50 rounded-xl p-4 border border-purple-100 mt-4">
                    <p id="ai-response-text" class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed italic"></p>
                    <button onclick="copyAiToNote()" class="mt-3 w-full py-2 bg-white border border-purple-200 rounded-lg text-purple-700 text-xs font-bold flex items-center justify-center gap-2 hover:bg-purple-100">
                        <i data-lucide="copy" class="w-3 h-3"></i> Salin Saran ke Catatan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw5n6RxBtmY46nwhN06K45uJAl0tFcL079Eh9YNYfZC_niVpJEtENDu4oPTK5CmOnUS/exec";
        const apiKey = ""; // API Key disuntikkan oleh runtime
        
        // --- STATE ---
        let products = [];
        let cart = [];
        let activeTab = 'all';
        let deliveryType = 'pickup';
        let aiResponseText = '';

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fetchMenu();
            renderTabs();
        });

        // --- FETCH DATA ---
        async function fetchMenu() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const data = await response.json();
                
                if (Array.isArray(data) && data.length > 0) {
                    products = data;
                } else {
                    products = []; // Fallback empty
                }
            } catch (error) {
                console.error("Gagal load menu", error);
                // Demo Data Fallback jika fetch gagal (opsional)
                products = [
                    { id: 1, category: 'kuliner', name: 'Nasi Ayam Bakar', price: 20000, desc: 'Menu favorit, ayam bakar bumbu rujak.', image: 'bg-orange-100' }
                ];
            } finally {
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('product-grid').classList.remove('hidden');
                renderProducts();
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderTabs() {
            const tabs = [
                { id: 'all', label: 'Semua', icon: '' },
                { id: 'kuliner', label: 'Kuliner', icon: 'utensils' },
                { id: 'balon', label: 'Balon', icon: 'party-popper' },
                { id: 'bucket', label: 'Bucket', icon: 'gift' }
            ];

            const container = document.getElementById('tabs-container');
            container.innerHTML = tabs.map(tab => `
                <button onclick="setTab('${tab.id}')" 
                    class="px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all border flex items-center gap-2
                    ${activeTab === tab.id 
                        ? getTabColor(tab.id, true) 
                        : 'bg-white text-gray-500 border-gray-200 hover:border-gray-400'}">
                    ${tab.icon ? `<i data-lucide="${tab.icon}" class="w-3 h-3"></i>` : ''} ${tab.label}
                </button>
            `).join('');
            lucide.createIcons();
        }

        function getTabColor(category, isActive) {
            if (!isActive) return '';
            if (category === 'kuliner') return 'bg-orange-600 text-white border-orange-600 shadow-md shadow-orange-200';
            if (category === 'balon') return 'bg-pink-500 text-white border-pink-500 shadow-md shadow-pink-200';
            if (category === 'bucket') return 'bg-blue-500 text-white border-blue-500 shadow-md shadow-blue-200';
            return 'bg-gray-800 text-white border-gray-800';
        }

        function renderProducts() {
            const container = document.getElementById('product-grid');
            const filtered = activeTab === 'all' ? products : products.filter(p => p.category === activeTab);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-10 text-gray-400">Belum ada menu di kategori ini.</div>`;
                return;
            }

            container.innerHTML = filtered.map(product => {
                // Logic Gambar/Placeholder
                let imgContent = '';
                const isUrl = product.image && product.image.includes('http');
                
                if (isUrl) {
                    imgContent = `<img src="${product.image}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">`;
                }
                
                // Fallback Placeholder
                let bgClass = (!isUrl && product.image && product.image.includes('bg-')) ? product.image : 'bg-gray-100';
                if (!product.image) {
                     if (product.category === 'kuliner') bgClass = 'bg-orange-100';
                     else if (product.category === 'balon') bgClass = 'bg-pink-100';
                     else bgClass = 'bg-blue-100';
                }

                const icon = product.category === 'kuliner' ? 'utensils' : product.category === 'balon' ? 'party-popper' : 'gift';
                const iconColor = product.category === 'kuliner' ? 'text-orange-500' : product.category === 'balon' ? 'text-pink-500' : 'text-blue-500';

                const placeholder = `
                    <div class="absolute inset-0 ${bgClass} flex items-center justify-center ${isUrl ? 'hidden' : 'flex'}">
                        <div class="relative z-10 bg-white/80 backdrop-blur p-4 rounded-full shadow-sm">
                            <i data-lucide="${icon}" class="w-8 h-8 ${iconColor}"></i>
                        </div>
                    </div>
                `;

                return `
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group animate-fade-in">
                    <div class="h-44 w-full relative overflow-hidden bg-gray-50">
                        ${imgContent}
                        ${placeholder}
                        <div class="absolute top-3 left-3 bg-white/90 backdrop-blur px-2 py-1 rounded-md text-[10px] font-extrabold text-gray-800 uppercase tracking-wide border border-gray-100 shadow-sm z-20">
                            ${product.category === 'kuliner' ? 'Dapur Sedayu' : 'Blooms'}
                        </div>
                    </div>
                    <div class="p-5 flex flex-col flex-grow bg-white">
                        <div class="flex-grow">
                            <h3 class="font-bold text-gray-800 text-lg leading-snug mb-1">${product.name}</h3>
                            <p class="text-gray-500 text-xs leading-relaxed line-clamp-2">${product.desc}</p>
                        </div>
                        <div class="mt-5 pt-4 border-t border-dashed border-gray-200 flex items-center justify-between">
                            <div>
                                <span class="text-[10px] text-gray-400 block font-bold uppercase">Harga</span>
                                <span class="font-black text-lg text-red-600">Rp ${Number(product.price).toLocaleString('id-ID')}</span>
                            </div>
                            <button onclick="addToCart(${product.id})" class="bg-gray-900 text-white w-10 h-10 rounded-xl flex items-center justify-center hover:bg-orange-600 transition-colors duration-300 shadow-md active:scale-90">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items');
            const footer = document.getElementById('cart-footer');
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center p-8 opacity-60">
                        <div class="bg-gray-200 p-6 rounded-full mb-4"><i data-lucide="shopping-bag" class="w-12 h-12 text-gray-400"></i></div>
                        <h3 class="text-gray-800 font-bold mb-1">Perut masih kosong?</h3>
                        <button onclick="toggleCart()" class="mt-6 px-6 py-2 bg-orange-600 text-white rounded-full text-sm font-bold hover:bg-orange-700 transition">Lihat Menu</button>
                    </div>`;
                footer.classList.add('hidden');
            } else {
                container.innerHTML = cart.map(item => `
                    <div class="flex gap-4 p-3 bg-white border border-gray-200 rounded-xl shadow-sm">
                        <div class="w-16 h-16 rounded-lg bg-gray-100 flex items-center justify-center flex-shrink-0">
                            <i data-lucide="package" class="w-5 h-5 text-gray-400"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 text-sm leading-tight">${item.name}</h4>
                            <p class="text-red-600 font-bold text-sm mt-1">Rp ${(item.price * item.qty).toLocaleString('id-ID')}</p>
                            <div class="flex items-center justify-between mt-3">
                                <div class="flex items-center space-x-3 bg-gray-50 rounded-lg p-1 border border-gray-200">
                                    <button onclick="updateQty(${item.id}, -1)" class="w-6 h-6 flex items-center justify-center bg-white rounded shadow-sm hover:text-red-500"><i data-lucide="minus" class="w-3 h-3"></i></button>
                                    <span class="text-xs font-bold w-4 text-center text-gray-800">${item.qty}</span>
                                    <button onclick="updateQty(${item.id}, 1)" class="w-6 h-6 flex items-center justify-center bg-white rounded shadow-sm hover:text-green-500"><i data-lucide="plus" class="w-3 h-3"></i></button>
                                </div>
                                <button onclick="removeItem(${item.id})" class="text-gray-300 hover:text-red-500 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                `).join('');
                footer.classList.remove('hidden');
            }
            lucide.createIcons();
            updateCartTotals();
        }

        // --- ACTIONS ---
        function setTab(id) {
            activeTab = id;
            renderTabs();
            renderProducts();
        }

        function addToCart(id) {
            const product = products.find(p => p.id == id); // id from HTML might be string/number
            const existing = cart.find(item => item.id == id);
            
            if (existing) {
                existing.qty += 1;
            } else {
                cart.push({ ...product, qty: 1 });
            }
            updateCartUI();
            toggleCart(true); // Open cart immediately
        }

        function updateQty(id, change) {
            const item = cart.find(i => i.id == id);
            if (item) {
                item.qty += change;
                if (item.qty <= 0) item.qty = 1; // Prevent 0 from minus button, use remove instead
            }
            renderCartItems();
        }

        function removeItem(id) {
            cart = cart.filter(item => item.id != id);
            updateCartUI();
            renderCartItems();
        }

        function updateCartUI() {
            const totalItems = cart.reduce((acc, item) => acc + item.qty, 0);
            const totalAmount = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);

            // Navbar Badge
            const badge = document.getElementById('cart-badge');
            badge.textContent = totalItems;
            badge.classList.toggle('hidden', totalItems === 0);

            // Mobile Floating Button
            const mobileBtn = document.getElementById('mobile-cart-btn');
            if (totalItems > 0) {
                mobileBtn.classList.remove('hidden');
                document.getElementById('mobile-cart-count').textContent = `${totalItems} Item`;
                document.getElementById('mobile-cart-total').textContent = `Rp ${totalAmount.toLocaleString('id-ID')}`;
            } else {
                mobileBtn.classList.add('hidden');
            }
        }

        function updateCartTotals() {
            const totalAmount = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            document.getElementById('cart-total-display').textContent = `Rp ${totalAmount.toLocaleString('id-ID')}`;
        }

        function toggleCart(forceOpen = false) {
            const modal = document.getElementById('cart-modal');
            const panel = document.getElementById('cart-panel');
            
            if (modal.classList.contains('hidden') || forceOpen === true) {
                modal.classList.remove('hidden');
                setTimeout(() => panel.classList.remove('translate-x-full'), 10);
                renderCartItems();
            } else {
                panel.classList.add('translate-x-full');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function setDelivery(type) {
            deliveryType = type;
            const btnPickup = document.getElementById('btn-pickup');
            const btnDelivery = document.getElementById('btn-delivery');
            const note = document.getElementById('delivery-note');

            if (type === 'pickup') {
                btnPickup.className = "py-3 px-2 rounded-xl border text-sm font-bold flex flex-col items-center justify-center gap-1 transition-all bg-orange-50 border-orange-500 text-orange-700 ring-1 ring-orange-500";
                btnDelivery.className = "py-3 px-2 rounded-xl border text-sm font-bold flex flex-col items-center justify-center gap-1 transition-all bg-white border-gray-200 text-gray-500 hover:bg-gray-50";
                note.classList.add('hidden');
            } else {
                btnDelivery.className = "py-3 px-2 rounded-xl border text-sm font-bold flex flex-col items-center justify-center gap-1 transition-all bg-orange-50 border-orange-500 text-orange-700 ring-1 ring-orange-500";
                btnPickup.className = "py-3 px-2 rounded-xl border text-sm font-bold flex flex-col items-center justify-center gap-1 transition-all bg-white border-gray-200 text-gray-500 hover:bg-gray-50";
                note.classList.remove('hidden');
            }
        }

        // --- CHECKOUT LOGIC ---
        async function processCheckout() {
            const name = document.getElementById('cust-name').value;
            const note = document.getElementById('cust-note').value;
            
            if (!name) {
                alert("Mohon isi nama Anda terlebih dahulu.");
                return;
            }

            // UI Loading
            const btn = document.getElementById('btn-checkout');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Memproses...`;
            btn.disabled = true;
            lucide.createIcons();

            // 1. Data untuk Google Sheet
            let itemsString = cart.map(i => `${i.name} (x${i.qty})`).join(', ');
            const totalAmount = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            const delInfo = deliveryType === 'delivery' ? "Antar Kurir (Ongkir COD)" : "Ambil di Dapur";
            const finalNote = `[${delInfo}] ${note}`;

            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nama: name,
                        nomor_hp: '-',
                        items: itemsString,
                        total: totalAmount,
                        catatan: finalNote
                    })
                });
            } catch (e) {
                console.error("Gagal simpan DB", e);
            }

            // 2. WhatsApp Struk
            const waNumber = "6281584448308";
            const dateStr = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });

            let msg = `üßæ *STRUK PESANAN - SEDAYU HUB* üßæ\n`;
            msg += `Tanggal: ${dateStr}\n`;
            msg += `Pemesan: *${name}*\n`;
            msg += `----------------------------------\n`;
            
            cart.forEach(item => {
                const sub = item.price * item.qty;
                msg += `${item.name}\n   ${item.qty} x Rp ${item.price.toLocaleString('id-ID')} = Rp ${sub.toLocaleString('id-ID')}\n`;
            });

            msg += `----------------------------------\n`;
            msg += `*TOTAL TAGIHAN: Rp ${totalAmount.toLocaleString('id-ID')}*\n`;
            msg += `----------------------------------\n`;
            msg += `üìã *Info Pengiriman:*\nMetode: ${deliveryType === 'delivery' ? 'üõµ Antar Kurir (Ongkir COD)' : 'üè™ Ambil di Dapur'}\n`;
            if (note) msg += `Catatan: ${note}\n`;
            msg += `\nüí≥ *Info Pembayaran Transfer:*\n‚Ä¢ BNI: 699441202 (Finda Fatmawati)\n‚Ä¢ BCA: 6225038906 (Finda Fatmawati)\n`;
            msg += `\nMohon proses pesanan saya. Bukti transfer akan saya kirim setelah ini. Terima kasih!`;

            window.open(`https://wa.me/${waNumber}?text=${encodeURIComponent(msg)}`, '_blank');

            // Reset
            cart = [];
            updateCartUI();
            toggleCart();
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        // --- AI LOGIC ---
        function toggleAI() {
            const modal = document.getElementById('ai-modal');
            modal.classList.toggle('hidden');
        }

        async function callGemini() {
            const prompt = document.getElementById('ai-prompt').value;
            if (!prompt) return;

            const btn = document.getElementById('btn-ask-ai');
            const resultBox = document.getElementById('ai-result-container');
            const resultText = document.getElementById('ai-response-text');

            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Sedang Berpikir...`;
            lucide.createIcons();

            try {
                const systemInstruction = `Kamu adalah asisten cerdas untuk 'Sedayu Hub', bisnis di Malang yang menjual Kuliner, Balon Dekorasi, dan Bucket Snack. Berikan rekomendasi produk dan contoh ucapan greeting card singkat dalam bahasa Indonesia yang akrab/gaul berdasarkan situasi user.`;
                
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `User request: "${prompt}"` }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] }
                        })
                    }
                );
                
                const data = await response.json();
                if (data.candidates && data.candidates[0].content) {
                    aiResponseText = data.candidates[0].content.parts[0].text;
                    resultText.textContent = aiResponseText;
                    resultBox.classList.remove('hidden');
                }
            } catch (error) {
                console.error("AI Error", error);
                alert("Maaf, AI sedang sibuk.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="send" class="w-4 h-4"></i> Tanya AI Sekarang`;
                lucide.createIcons();
            }
        }

        function copyAiToNote() {
            const noteArea = document.getElementById('cust-note');
            noteArea.value = (noteArea.value ? noteArea.value + "\n\n" : "") + "[Saran AI]: " + aiResponseText;
            toggleAI();
            toggleCart(true); // Open cart to show note
        }

    </script>
</body>
</html>
