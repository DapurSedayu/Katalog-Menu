<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sedayu Hub - Kuliner, Balon & Bucket</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icon Library -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .pattern-icon { position: absolute; opacity: 0.08; pointer-events: none; color: #9CA3AF; /* gray-400 */ }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-custom { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-[#FDFBF7] text-gray-800 relative overflow-x-hidden min-h-screen pb-24 md:pb-0">

    <!-- BACKGROUND PATTERN (Rempah Hitam Putih) -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <!-- Pojok Kiri Atas -->
        <svg class="pattern-icon w-48 h-48 -top-10 -left-10 rotate-45" fill="currentColor" viewBox="0 0 24 24"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path></svg>
        <!-- Bunga Lawang (Flower) - Atas Tengah -->
        <svg class="pattern-icon w-24 h-24 top-5 left-1/4 rotate-12 opacity-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M12 7.5a4.5 4.5 0 1 1 4.5 4.5M12 7.5A4.5 4.5 0 1 0 7.5 12M12 7.5V9m0 0v3m0-3h3m-3 0H9m12 3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
        
        <!-- Padi (Wheat) - Kanan Atas -->
        <svg class="pattern-icon w-40 h-40 top-10 -right-10 rotate-[130deg]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M2 22l10-10"></path><path d="M16 8l-2-2"></path><path d="M9 15l2-2"></path></svg>
        
        <!-- Cabai/Api (Flame) - Kiri Tengah -->
        <svg class="pattern-icon w-32 h-32 top-1/3 -left-5 -rotate-12" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-5-6.33-5-6.33S1 10.62 1 12a2.5 2.5 0 0 0 2.5 2.5 2.5 2.5 0 0 0 2.5-2.5 2.5 2.5 0 0 0 2.5 2.5z"/></svg>
        
        <!-- Biji Lada (Dots) - Tengah -->
        <div class="pattern-icon top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 opacity-5">
            <svg class="w-64 h-64" viewBox="0 0 100 100" fill="currentColor">
                <circle cx="10" cy="20" r="2" /> <circle cx="30" cy="50" r="3" /> <circle cx="70" cy="30" r="2" />
                <circle cx="90" cy="80" r="3" /> <circle cx="50" cy="90" r="2" /> <circle cx="20" cy="80" r="2" />
            </svg>
        </div>

        <!-- Daun Salam (Leaf) - Kanan Tengah -->
        <svg class="pattern-icon w-28 h-28 top-1/2 right-0 rotate-[-45deg]" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path></svg>

        <!-- Bawang/Citrus - Kiri Bawah -->
        <svg class="pattern-icon w-36 h-36 bottom-20 -left-10 rotate-12" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 2v20"/><path d="M2 12h20"/></svg>

        <!-- Uap (Soup) - Kanan Bawah -->
        <svg class="pattern-icon w-48 h-48 -bottom-10 -right-10" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M12 21a9 9 0 0 0 9-9H3a9 9 0 0 0 9 9Z"/><path d="M7 21h10"/><path d="M12 3v8"/></svg>
    </div>

    <!-- NAVBAR -->
    <nav class="glass shadow-sm sticky top-0 z-40 border-b border-orange-100">
        <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="h-12 w-12 rounded-lg overflow-hidden flex items-center justify-center bg-white shadow-sm border border-orange-50">
                    <img src="https://i.ibb.co.com/S4Mt28HZ/Whats-App-Image-2025-12-10-at-11-07-06.jpg" alt="Logo" class="w-full h-full object-cover p-0">
                </div>
                <div>
                    <h1 class="text-xl font-extrabold text-gray-800 leading-tight">Sedayu Hub</h1>
                    <p class="text-xs text-orange-600 font-semibold">Sawojajar 1, Malang</p>
                </div>
            </div>
            <button onclick="toggleCart()" class="relative p-2 text-gray-600 hover:bg-orange-50 rounded-full transition-colors">
                <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                <span id="cart-badge" class="hidden absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full shadow-sm animate-pulse">0</span>
            </button>
        </div>
    </nav>

    <!-- HERO SECTION -->
    <div class="max-w-4xl mx-auto pt-6 px-4 pb-2 relative z-10">
        <div class="bg-gradient-to-r from-orange-600 to-red-700 text-white py-10 px-6 text-center rounded-2xl shadow-xl shadow-orange-200 relative overflow-hidden">
            <div class="absolute opacity-10 top-0 left-0 w-full h-full pointer-events-none">
                 <i data-lucide="chef-hat" class="absolute top-2 left-2 w-20 h-20 text-white opacity-20 rotate-12"></i>
                 <i data-lucide="party-popper" class="absolute bottom-2 right-2 w-24 h-24 text-yellow-300 opacity-20 -rotate-12"></i>
            </div>
            <div class="relative z-10">
                <h2 class="text-3xl md:text-4xl font-black mb-3 drop-shadow-md">Citarasa & Cerita</h2>
                <p class="text-orange-50 text-sm md:text-base max-w-lg mx-auto mb-6 font-medium">Dari dapur penuh rempah hingga dekorasi penuh warna. <span class="block mt-1 font-bold text-yellow-200">Spesial untuk momen Anda.</span></p>
                <div class="flex justify-center gap-3">
                    <a href="https://instagram.com/dapur.sedayu" target="_blank" class="flex items-center space-x-2 bg-white text-orange-600 px-4 py-2 rounded-full text-xs font-bold hover:bg-orange-50 transition shadow-sm border-b-2 border-orange-200">
                        <i data-lucide="instagram" class="w-3 h-3"></i> <span>@dapur.sedayu</span>
                    </a>
                    <a href="https://instagram.com/bloomsbaloon" target="_blank" class="flex items-center space-x-2 bg-white/20 text-white px-4 py-2 rounded-full text-xs font-bold hover:bg-white/30 transition backdrop-blur-sm border border-white/30">
                        <i data-lucide="instagram" class="w-3 h-3"></i> <span>@bloomsbaloon</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- TABS -->
    <div class="max-w-4xl mx-auto px-4 my-6 sticky top-[72px] z-30 bg-[#FDFBF7]/95 backdrop-blur py-2">
        <div class="flex space-x-2 overflow-x-auto pb-1 scrollbar-hide" id="tabs-container">
            <!-- Tabs di-render via JS -->
        </div>
    </div>

    <!-- PRODUCT GRID -->
    <div class="max-w-4xl mx-auto px-4 mb-24 relative z-10">
        <div id="loading-indicator" class="flex flex-col items-center justify-center py-20">
            <i data-lucide="loader-2" class="w-10 h-10 text-orange-500 animate-spin-custom mb-2"></i>
            <p class="text-gray-500 text-sm font-medium">Sedang mengambil menu terbaru...</p>
        </div>
        <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-5 hidden">
            <!-- Produk di-render via JS -->
        </div>
    </div>

    <!-- AI FLOATING BUTTON -->
    <div class="fixed bottom-24 left-4 z-30">
        <button onclick="toggleAI()" class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-3 rounded-full shadow-xl shadow-purple-500/30 flex items-center gap-2 hover:scale-105 transition-transform">
            <i data-lucide="sparkles" class="w-6 h-6 animate-pulse"></i>
            <span class="font-bold text-sm hidden md:block">Asisten Ajaib</span>
        </button>
    </div>

    <!-- MOBILE CART BUTTON -->
    <div id="mobile-cart-btn" class="fixed bottom-6 left-4 right-4 md:hidden z-30 hidden">
        <button onclick="toggleCart()" class="w-full bg-gray-900 text-white shadow-2xl shadow-gray-900/40 py-4 px-6 rounded-2xl flex items-center justify-between border-t border-gray-700 backdrop-blur-xl">
            <div class="flex items-center space-x-3">
                <div class="bg-red-500 px-2.5 py-1 rounded-lg text-xs font-bold text-white" id="mobile-cart-count">0 Item</div>
                <span class="font-semibold text-sm text-gray-200">Total Pesanan</span>
            </div>
            <span class="font-bold text-lg text-white" id="mobile-cart-total">Rp 0</span>
        </button>
    </div>

    <!-- CART MODAL -->
    <div id="cart-modal" class="fixed inset-0 z-50 flex justify-end hidden">
        <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="toggleCart()"></div>
        <div class="relative w-full max-w-md bg-[#FDFBF7] h-full shadow-2xl flex flex-col transform transition-transform duration-300 translate-x-full" id="cart-panel">
            <div class="p-5 border-b border-gray-200 flex items-center justify-between bg-white">
                <h2 class="text-lg font-bold flex items-center gap-2 text-gray-800">
                    <i data-lucide="shopping-cart" class="w-5 h-5 text-orange-600"></i> Checkout
                </h2>
                <button onclick="toggleCart()" class="p-2 hover:bg-gray-100 rounded-full text-gray-400 hover:text-red-500 transition"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto p-5 space-y-4" id="cart-items"></div>

            <div id="cart-footer" class="hidden p-5 border-t border-gray-200 bg-white space-y-4 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
                
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block">Opsi Pengiriman</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="setDelivery('pickup')" id="btn-pickup" class="py-3 px-2 rounded-xl border text-sm font-bold flex flex-col items-center justify-center gap-1 transition-all bg-orange-50 border-orange-500 text-orange-700">
                            <i data-lucide="store" class="w-4 h-4"></i> Ambil di Dapur
                        </button>
                        <button onclick="setDelivery('delivery')" id="btn-delivery" class="py-3 px-2 rounded-xl border text-sm font-bold flex flex-col items-center justify-center gap-1 transition-all bg-white border-gray-200 text-gray-500">
                            <i data-lucide="bike" class="w-4 h-4"></i> Antar Kurir
                        </button>
                    </div>
                    <p id="delivery-note" class="hidden text-[10px] text-center text-orange-600 bg-orange-50 py-1 rounded font-medium">*Ongkir dibayar tunai ke kurir (COD)</p>
                </div>

                <div class="space-y-3">
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-1">Nama Pemesan</label>
                        <input type="text" id="cust-name" placeholder="Nama Anda..." class="w-full bg-transparent text-sm font-bold text-gray-800 outline-none placeholder:font-normal">
                    </div>
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider block mb-1">Catatan</label>
                        <textarea id="cust-note" placeholder="Contoh: Pedas, pita biru..." class="w-full bg-transparent text-sm font-medium text-gray-800 outline-none h-10 resize-none placeholder:font-normal"></textarea>
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-3">
                    <div class="flex items-center gap-2 mb-1">
                        <i data-lucide="credit-card" class="w-4 h-4 text-blue-600"></i>
                        <span class="text-[10px] font-bold text-blue-600 uppercase tracking-wider">Transfer Pembayaran</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-3 bg-white p-2 rounded-lg border border-blue-100">
                            <div class="h-6 w-10 bg-blue-600 rounded flex items-center justify-center text-[10px] font-bold text-white">BNI</div>
                            <div><p class="text-xs font-bold text-gray-800">699441202</p><p class="text-[10px] text-gray-500">Finda Fatmawati</p></div>
                        </div>
                        <div class="flex items-center gap-3 bg-white p-2 rounded-lg border border-blue-100">
                            <div class="h-6 w-10 bg-blue-800 rounded flex items-center justify-center text-[10px] font-bold text-white">BCA</div>
                            <div><p class="text-xs font-bold text-gray-800">6225038906</p><p class="text-[10px] text-gray-500">Finda Fatmawati</p></div>
                        </div>
                    </div>
                </div>

                <div class="pt-2">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-gray-500 text-sm font-medium">Total Tagihan</span>
                        <span class="text-xl font-black text-gray-900" id="cart-total-display">Rp 0</span>
                    </div>
                    <button onclick="processCheckout()" id="btn-checkout" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-green-200 active:scale-[0.98] transition-all">
                        <i data-lucide="file-text" class="w-5 h-5"></i> Kirim Struk & Order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI MODAL -->
    <div id="ai-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleAI()"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-fade-in">
            <button onclick="toggleAI()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center p-3 bg-purple-100 rounded-full mb-3 text-purple-600">
                    <i data-lucide="sparkles" class="w-7 h-7"></i>
                </div>
                <h3 class="text-xl font-black text-gray-800">Sedayu AI Assistant âœ¨</h3>
                <p class="text-sm text-gray-500 mt-1">Bingung mau kasih kado apa? Atau butuh ucapan keren? Ceritain aja!</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-600 uppercase mb-1 block">Ceritakan situasimu</label>
                    <textarea id="ai-prompt" class="w-full border border-gray-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-purple-500 outline-none resize-none h-24 bg-gray-50" placeholder="Contoh: Ulang tahun pacar suka warna biru, atau acara perpisahan teman kantor..."></textarea>
                </div>
                <button onclick="callGemini()" id="btn-ask-ai" class="w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2 text-white bg-purple-600 hover:bg-purple-700 shadow-lg shadow-purple-200 transition-all">
                    <i data-lucide="send" class="w-4 h-4"></i> Tanya AI Sekarang
                </button>
                <div id="ai-result-container" class="hidden bg-purple-50 rounded-xl p-4 border border-purple-100 mt-4">
                    <p id="ai-response-text" class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed italic"></p>
                    <button onclick="copyAiToNote()" class="mt-3 w-full py-2 bg-white border border-purple-200 rounded-lg text-purple-700 text-xs font-bold flex items-center justify-center gap-2 hover:bg-purple-100">
                        <i data-lucide="copy" class="w-3 h-3"></i> Salin Saran ke Catatan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIKA JAVASCRIPT -->
    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw5n6RxBtmY46nwhN06K45uJAl0tFcL079Eh9YNYfZC_niVpJEtENDu4oPTK5CmOnUS/exec";
        const apiKey = ""; 

        let products = [];
        let cart = [];
        let activeTab = 'all';
        let deliveryType = 'pickup';
        let aiResponseText = '';

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fetchMenu();
            renderTabs();
            
            // --- LOAD SAVED NAME (AUTO SAVE FEATURE) ---
            const savedName = localStorage.getItem('sedayu_customer_name');
            if (savedName) {
                document.getElementById('cust-name').value = savedName;
            }
        });

        async function fetchMenu() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const data = await response.json();
                if (Array.isArray(data) && data.length > 0) products = data;
            } catch (error) {
                console.error("Gagal load menu", error);
            } finally {
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('product-grid').classList.remove('hidden');
                renderProducts();
            }
        }

        // --- UPDATE TABS (New Minuman Category) ---
        function renderTabs() {
            const tabs = [
                { id: 'all', label: 'Semua', icon: '' },
                { id: 'kuliner', label: 'Kuliner', icon: 'utensils' },
                { id: 'minuman', label: 'Minuman', icon: 'cup-soda' },
                { id: 'balon', label: 'Balon', icon: 'party-popper' },
                { id: 'bucket', label: 'Bucket', icon: 'gift' }
            ];
            const container = document.getElementById('tabs-container');
            container.innerHTML = tabs.map(tab => `
                <button onclick="setTab('${tab.id}')" 
                    class="px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-all border flex items-center gap-2
                    ${activeTab === tab.id ? getTabColor(tab.id) : 'bg-white text-gray-500 border-gray-200 hover:border-gray-400'}">
                    ${tab.icon ? `<i data-lucide="${tab.icon}" class="w-3 h-3"></i>` : ''} ${tab.label}
                </button>
            `).join('');
            lucide.createIcons();
        }

        function getTabColor(category) {
            if (category === 'kuliner') return 'bg-orange-600 text-white border-orange-600 shadow-md shadow-orange-200';
            if (category === 'balon') return 'bg-pink-500 text-white border-pink-500 shadow-md shadow-pink-200';
            if (category === 'bucket') return 'bg-blue-500 text-white border-blue-500 shadow-md shadow-blue-200';
            if (category === 'minuman') return 'bg-teal-500 text-white border-teal-500 shadow-md shadow-teal-200'; 
            return 'bg-gray-800 text-white border-gray-800';
        }

        function setTab(id) {
            activeTab = id;
            renderTabs();
            renderProducts();
        }

        function renderProducts() {
            const container = document.getElementById('product-grid');
            const filtered = activeTab === 'all' ? products : products.filter(p => p.category === activeTab);

            if (filtered.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-10 text-gray-400">Belum ada menu di kategori ini.</div>`;
                return;
            }

            container.innerHTML = filtered.map(product => {
                let imgContent = '';
                const isUrl = product.image && product.image.includes('http');
                if (isUrl) {
                    imgContent = `<img src="${product.image}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">`;
                }
                
                let bgClass = (!isUrl && product.image && product.image.includes('bg-')) ? product.image : 'bg-gray-100';
                if (!product.image) {
                     if (product.category === 'kuliner') bgClass = 'bg-orange-100';
                     else if (product.category === 'balon') bgClass = 'bg-pink-100';
                     else if (product.category === 'minuman') bgClass = 'bg-teal-100';
                     else bgClass = 'bg-blue-100';
                }

                const icon = product.category === 'kuliner' ? 'utensils' : product.category === 'balon' ? 'party-popper' : product.category === 'minuman' ? 'cup-soda' : 'gift';
                const iconColor = product.category === 'kuliner' ? 'text-orange-500' : product.category === 'balon' ? 'text-pink-500' : product.category === 'minuman' ? 'text-teal-500' : 'text-blue-500';

                // --- STOK LOGIC ---
                const currentStock = (product.stock === undefined || product.stock === "") ? 999 : parseInt(product.stock);
                const isSoldOut = currentStock <= 0;

                let actionButton = '';
                if (isSoldOut) {
                    actionButton = `
                    <button disabled class="bg-gray-200 text-gray-500 px-4 py-2 rounded-xl text-xs font-bold cursor-not-allowed">
                        HABIS
                    </button>`;
                } else {
                    actionButton = `
                    <button onclick="addToCart('${product.id}')" class="bg-gray-900 text-white w-10 h-10 rounded-xl flex items-center justify-center hover:bg-orange-600 transition-colors duration-300 shadow-md active:scale-90">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>`;
                }

                const soldOutOverlay = isSoldOut ? 
                    `<div class="absolute inset-0 bg-black/50 flex items-center justify-center z-30">
                        <span class="text-white font-black text-xl border-4 border-white px-4 py-2 rotate-[-12deg] tracking-widest">SOLD OUT</span>
                    </div>` : '';

                return `
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group animate-fade-in ${isSoldOut ? 'grayscale opacity-80' : ''}">
                    <div class="h-80 w-full relative overflow-hidden bg-gray-50">
                        ${imgContent}
                        ${soldOutOverlay}
                        <div class="absolute inset-0 ${bgClass} flex items-center justify-center ${isUrl ? 'hidden' : 'flex'}">
                            <div class="relative z-10 bg-white/80 backdrop-blur p-4 rounded-full shadow-sm">
                                <i data-lucide="${icon}" class="w-8 h-8 ${iconColor}"></i>
                            </div>
                        </div>
                    </div>
                    <div class="p-5 flex flex-col flex-grow bg-white">
                        <div class="flex-grow">
                            <h3 class="font-bold text-gray-800 text-lg leading-snug mb-1">${product.name}</h3>
                            <p class="text-gray-500 text-xs leading-relaxed line-clamp-2">${product.desc}</p>
                            ${!isSoldOut && currentStock < 10 ? `<p class="text-[10px] text-red-500 font-bold mt-1">Sisa ${currentStock} item!</p>` : ''}
                        </div>
                        <div class="mt-5 pt-4 border-t border-dashed border-gray-200 flex items-center justify-between">
                            <div>
                                <span class="text-[10px] text-gray-400 block font-bold uppercase">Harga</span>
                                <span class="font-black text-lg text-red-600">Rp ${Number(product.price).toLocaleString('id-ID')}</span>
                            </div>
                            ${actionButton}
                        </div>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        function addToCart(id) {
            const product = products.find(p => p.id == id);
            
            // Cek Stok Client-Side
            const currentStock = (product.stock === undefined || product.stock === "") ? 999 : parseInt(product.stock);
            const existing = cart.find(item => item.id == id);
            const currentQty = existing ? existing.qty : 0;

            if (currentQty >= currentStock) {
                alert("Maaf, stok tidak mencukupi!");
                return;
            }

            if (existing) existing.qty += 1;
            else cart.push({ ...product, qty: 1 });
            
            updateCartUI();
            toggleCart(true);
        }

        function updateQty(id, change) {
            const item = cart.find(i => i.id == id);
            const product = products.find(p => p.id == id);
            const currentStock = (product.stock === undefined || product.stock === "") ? 999 : parseInt(product.stock);

            if (item) {
                const newQty = item.qty + change;
                if (newQty > currentStock) {
                    alert("Maksimal stok tercapai!");
                    return;
                }
                item.qty = newQty;
                if (item.qty <= 0) item.qty = 1;
            }
            renderCartItems();
            updateCartUI();
        }

        function removeItem(id) {
            cart = cart.filter(item => item.id != id);
            updateCartUI();
            renderCartItems();
        }

        function updateCartUI() {
            const totalItems = cart.reduce((acc, item) => acc + item.qty, 0);
            const totalAmount = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            
            document.getElementById('cart-badge').textContent = totalItems;
            document.getElementById('cart-badge').classList.toggle('hidden', totalItems === 0);
            
            const mobileBtn = document.getElementById('mobile-cart-btn');
            if (totalItems > 0) {
                mobileBtn.classList.remove('hidden');
                document.getElementById('mobile-cart-count').textContent = `${totalItems} Item`;
                document.getElementById('mobile-cart-total').textContent = `Rp ${totalAmount.toLocaleString('id-ID')}`;
            } else {
                mobileBtn.classList.add('hidden');
            }
            renderCartItems();
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items');
            const footer = document.getElementById('cart-footer');
            if (cart.length === 0) {
                container.innerHTML = `<div class="text-center p-8 opacity-60"><h3 class="font-bold">Keranjang Kosong</h3></div>`;
                footer.classList.add('hidden');
            } else {
                container.innerHTML = cart.map(item => `
                    <div class="flex gap-4 p-3 bg-white border border-gray-200 rounded-xl shadow-sm">
                        <div class="flex-1">
                            <h4 class="font-bold text-sm">${item.name}</h4>
                            <p class="text-red-600 font-bold text-sm">Rp ${(item.price * item.qty).toLocaleString('id-ID')}</p>
                            <div class="flex items-center justify-between mt-2">
                                <div class="flex gap-2">
                                    <button onclick="updateQty('${item.id}', -1)" class="p-1 border rounded"><i data-lucide="minus" class="w-3 h-3"></i></button>
                                    <span class="font-bold text-sm">${item.qty}</span>
                                    <button onclick="updateQty('${item.id}', 1)" class="p-1 border rounded"><i data-lucide="plus" class="w-3 h-3"></i></button>
                                </div>
                                <button onclick="removeItem('${item.id}')" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>`).join('');
                footer.classList.remove('hidden');
                const total = cart.reduce((acc, i) => acc + (i.price * i.qty), 0);
                document.getElementById('cart-total-display').textContent = `Rp ${total.toLocaleString('id-ID')}`;
            }
            lucide.createIcons();
        }

        function toggleCart(forceOpen = false) {
            const modal = document.getElementById('cart-modal');
            const panel = document.getElementById('cart-panel');
            if (modal.classList.contains('hidden') || forceOpen === true) {
                modal.classList.remove('hidden');
                setTimeout(() => panel.classList.remove('translate-x-full'), 10);
            } else {
                panel.classList.add('translate-x-full');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function setDelivery(type) {
            deliveryType = type;
            document.getElementById('btn-pickup').className = type === 'pickup' ? "py-3 px-2 rounded-xl border text-sm font-bold flex flex-col items-center justify-center gap-1 transition-all bg-orange-50 border-orange-500 text-orange-700 ring-1 ring-orange-500" : "py-3 px-2 rounded-xl border text-sm font-bold flex flex-col items-center justify-center gap-1 transition-all bg-white border-gray-200 text-gray-500 hover:bg-gray-50";
            document.getElementById('btn-delivery').className = type === 'delivery' ? "py-3 px-2 rounded-xl border text-sm font-bold flex flex-col items-center justify-center gap-1 transition-all bg-orange-50 border-orange-500 text-orange-700 ring-1 ring-orange-500" : "py-3 px-2 rounded-xl border text-sm font-bold flex flex-col items-center justify-center gap-1 transition-all bg-white border-gray-200 text-gray-500 hover:bg-gray-50";
            document.getElementById('delivery-note').classList.toggle('hidden', type !== 'delivery');
        }

        async function processCheckout() {
            const name = document.getElementById('cust-name').value;
            const note = document.getElementById('cust-note').value;
            if (!name) { alert("Isi nama dulu ya!"); return; }

            // --- SAVE NAME TO LOCAL STORAGE ---
            localStorage.setItem('sedayu_customer_name', name);

            const btn = document.getElementById('btn-checkout');
            const originalText = btn.innerHTML;
            btn.innerHTML = "Memproses...";
            btn.disabled = true;

            const itemsStr = cart.map(i => `${i.name} (x${i.qty})`).join(', ');
            const total = cart.reduce((acc, i) => acc + (i.price * i.qty), 0);
            const delInfo = deliveryType === 'delivery' ? "Antar Kurir" : "Ambil di Dapur";
            
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ nama: name, nomor_hp: '-', items: itemsStr, total: total, catatan: `[${delInfo}] ${note}` })
                });
            } catch (e) { console.error(e); }

            const waMsg = `ðŸ§¾ *STRUK SEDAYU HUB*\nNama: ${name}\nTotal: Rp ${total.toLocaleString('id-ID')}\nMetode: ${delInfo}\nCatatan: ${note}\n\nItem:\n${itemsStr}\n\nMohon diproses, terima kasih!`;
            window.open(`https://wa.me/6281584448308?text=${encodeURIComponent(waMsg)}`, '_blank');
            
            cart = [];
            updateCartUI();
            toggleCart();
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        function toggleAI() {
            document.getElementById('ai-modal').classList.toggle('hidden');
        }

        async function callGemini() {
            const prompt = document.getElementById('ai-prompt').value;
            if(!prompt) return;
            const btn = document.getElementById('btn-ask-ai');
            btn.innerHTML = "Mikir bentar...";
            btn.disabled = true;
            
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `User request: "${prompt}"` }] }], systemInstruction: { parts: [{ text: "Kamu asisten Sedayu Hub. Kasih saran produk & ucapan greeting card gaul." }] } })
                });
                const data = await res.json();
                if(data.candidates) {
                    aiResponseText = data.candidates[0].content.parts[0].text;
                    document.getElementById('ai-response-text').textContent = aiResponseText;
                    document.getElementById('ai-result-container').classList.remove('hidden');
                }
            } catch(e) { alert("AI lagi sibuk."); } 
            finally { btn.innerHTML = "Tanya AI Lagi"; btn.disabled = false; }
        }

        function copyAiToNote() {
            const note = document.getElementById('cust-note');
            note.value = (note.value ? note.value + "\n\n" : "") + "[Saran AI]: " + aiResponseText;
            toggleAI();
            toggleCart(true);
        }
    </script>
</body>
</html>
